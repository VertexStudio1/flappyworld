<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>Flappy World - Full Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        body { margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; background: #1a1a1a; font-family: 'Press Start 2P', cursive; overflow: hidden; }
        #game-container { position: relative; width: 320px; height: 480px; overflow: hidden; border: 4px solid #fff; }
        canvas { display: block; width: 100%; height: 100%; }
        
        .shutter { position: absolute; top: 0; width: 50%; height: 100%; background: #5d4037; z-index: 3000; transition: 0.4s; pointer-events: none; }
        #shutter-l { left: 0; transform: translateX(-100%); border-right: 2px solid #000; }
        #shutter-r { right: 0; transform: translateX(100%); border-left: 2px solid #000; }
        .shutter.active { transform: translateX(0) !important; }

        .ui-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.7); z-index: 1000; }
        .main-panel { background: #7a7a7a; border: 4px solid #000; padding: 15px; width: 85%; text-align: center; color: white; box-shadow: 4px 4px 0 #000; }
        .btn { background: #4e4e4e; border: 3px solid #000; color: white; padding: 10px; margin: 5px 0; cursor: pointer; font-size: 8px; width: 100%; font-family: 'Press Start 2P'; }
        .btn:hover { background: #7ebd2a; }
        .save-btn { background: #2196F3 !important; }
        
        .settings-icon { position: absolute; top: 15px; right: 15px; width: 40px; height: 40px; background: #4e4e4e; border: 3px solid #000; cursor: pointer; z-index: 4000; display: flex; justify-content: center; align-items: center; color: white; font-size: 20px; }
        .hidden { display: none !important; }
        
        .char-option { width: 45px; height: 45px; border: 2px solid #000; cursor: pointer; background: #666; margin: 2px; }
        .char-option.selected { border-color: #fff; background: #7ebd2a; }
        .color-dot { width: 25px; height: 25px; border: 2px solid #000; cursor: pointer; margin: 2px; }
        .color-dot.selected { border-color: #fff; transform: scale(1.1); }
        
        #preview-box { width: 60px; height: 60px; margin: 10px auto; background: rgba(0,0,0,0.3); border: 2px solid #fff; display: flex; align-items: center; justify-content: center; }
        
        .game-title { 
            color: #f7e339; 
            font-size: 20px; 
            margin: 10px 0;
            padding: 5px;
            -webkit-text-stroke: 1px rgba(0,0,0,0.5); 
            text-shadow: 3px 3px 0px rgba(0,0,0,0.8);
            letter-spacing: -1px;
            display: block;
        }
        .high-score-text { color: #fff; font-size: 8px; margin-bottom: 20px; opacity: 1; text-shadow: 2px 2px 0 #000; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas" width="320" height="480"></canvas>
    <div id="shutter-l" class="shutter"></div><div id="shutter-r" class="shutter"></div>
    <div class="settings-icon" onclick="toggleSettings()">⚙️</div>

    <div id="mainLobby" class="ui-overlay">
        <div class="main-panel">
            <h1 class="game-title" id="ui-title">FLAPPY WORLD</h1>
            <p class="high-score-text" id="ui-highscore">BEST: 0</p>
            <button class="btn" id="ui-play" onclick="prepareToPlay()">PLAY</button>
            <button class="btn" id="ui-birds" onclick="showChars()">BIRDS</button>
        </div>
    </div>

    <div id="charMenu" class="ui-overlay hidden">
        <div class="main-panel">
            <div id="preview-box"><canvas id="pCanvas" width="50" height="50"></canvas></div>
            <div style="display:flex; flex-wrap:wrap; justify-content:center; margin-bottom:10px;" id="birds-list"></div>
            <div style="display:flex; flex-wrap:wrap; justify-content:center; border-top:1px solid #444; padding-top:10px;" id="colors-list"></div>
            <div style="display:flex; gap:5px; margin-top:15px;">
                <button class="btn" onclick="cancelSelection()">BACK</button>
                <button class="btn save-btn" onclick="saveSelection()">SAVE</button>
            </div>
        </div>
    </div>

    <div id="settingsMenu" class="ui-overlay hidden">
        <div class="main-panel">
            <h2 style="font-size:12px;">SETTINGS</h2>
            <button class="btn" id="set-audio" onclick="cycleAudio()">AUDIO: ON</button>
            <button class="btn" id="set-lang" onclick="cycleLang()">LANG: EN</button>
            <button class="btn save-btn" onclick="saveSettings()">SAVE</button>
        </div>
    </div>

    <div id="gameOverMenu" class="ui-overlay hidden">
        <div class="main-panel">
            <h2 style="color:#ff4444; -webkit-text-stroke:1px #000;">CRASHED!</h2>
            <p id="txt-score" style="font-size:10px;">SCORE: 0</p>
            <button class="btn" onclick="prepareToPlay()">RETRY</button>
            <button class="btn" onclick="transitionToLobby()">LOBBY</button>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById("gameCanvas"), ctx = canvas.getContext("2d");
    const pCanvas = document.getElementById("pCanvas"), pCtx = pCanvas.getContext("2d");

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(freq, type, duration) {
        if (!isAudioOn) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + duration);
    }

    let isAudioOn = true, currentLang = 'EN';
    let savedBird = 0, savedColor = "#F7E339";
    let currentBird = 0, currentColor = "#F7E339";
    let bird, pipes, frame = 0, score = 0, gameOver, gameRunning = false, waitingToStart = false;
    let highScore = localStorage.getItem('flappyWorldBest') || 0;

    const birdColors = ["#F7E339", "#FF5252", "#4CAF50", "#2196F3", "#FFFFFF", "#E91E63", "#9C27B0"];
    const langs = {
        'EN': { title: 'FLAPPY WORLD', play: 'PLAY', birds: 'BIRDS', best: 'BEST: ' },
        'AR': { title: 'عالم فـلابـي', play: 'لعب', birds: 'الطيور', best: 'أفضل سكور: ' }
    };

    const stars = Array.from({ length: 50 }, () => ({ x: Math.random() * 320, y: Math.random() * 480, s: Math.random() * 2 }));

    function drawBackground() {
        let bg = "#70c5ce";
        if (score >= 15 && score < 25) bg = "#4ea1ad";
        if (score >= 25 && score < 100) bg = "#0b0b1a";
        if (score >= 100) bg = "#2e0854";
        ctx.fillStyle = bg; ctx.fillRect(0, 0, 320, 480);
        if (score < 15) {
            ctx.fillStyle = "white";
            ctx.beginPath(); ctx.arc(50, 80, 20, 0, Math.PI*2); ctx.arc(80, 80, 25, 0, Math.PI*2); ctx.arc(110, 80, 20, 0, Math.PI*2); ctx.fill();
        }
        if (score >= 25) {
            ctx.fillStyle = score >= 100 ? "hsl(" + (frame % 360) + ", 70%, 70%)" : "white";
            stars.forEach(s => { ctx.fillRect(s.x, s.y, s.s, s.s); });
        }
    }

    function updateHighScoreUI() { document.getElementById('ui-highscore').innerText = langs[currentLang].best + highScore; }

    function drawBird(c, x, y, type, color, wingVal, size=1) {
        c.save(); c.translate(x, y); c.scale(size, size);
        if(c === ctx && !waitingToStart) c.rotate(Math.min(Math.PI/4, Math.max(-Math.PI/4, bird.velocity * 0.1)));
        c.fillStyle = color; c.strokeStyle = "#000"; c.lineWidth = 2;
        if(type === 0) { c.beginPath(); c.ellipse(0, 0, 16, 12, 0, 0, Math.PI*2); c.fill(); c.stroke(); }
        else if(type === 1) { c.beginPath(); c.arc(0, 0, 13, 0, Math.PI*2); c.fill(); c.stroke(); }
        else if(type === 2) { c.beginPath(); c.moveTo(-15, 10); c.lineTo(15, 10); c.lineTo(0, -15); c.closePath(); c.fill(); c.stroke(); }
        else if(type === 3) { c.beginPath(); c.ellipse(0, 0, 18, 9, 0, 0, Math.PI*2); c.fill(); c.stroke(); }
        else { c.fillRect(-12, -12, 24, 24); c.strokeRect(-12, -12, 24, 24); }
        c.fillStyle = "#fff"; c.beginPath(); c.arc(8, -4, 4, 0, Math.PI*2); c.fill(); c.stroke();
        c.fillStyle = "#f57c00"; c.beginPath(); c.moveTo(10, 0); c.lineTo(18, 2); c.lineTo(10, 4); c.closePath(); c.fill(); c.stroke();
        let wy = Math.sin(wingVal) * 5;
        c.fillStyle = "#fff"; c.beginPath(); c.ellipse(-6, wy, 7, 4, 0, 0, Math.PI*2); c.fill(); c.stroke();
        c.restore();
    }

    function renderChars() {
        const bl = document.getElementById('birds-list'); bl.innerHTML = '';
        for(let i=0; i<5; i++) {
            let d = document.createElement('canvas'); d.width=45; d.height=45; d.className = `char-option ${i===currentBird?'selected':''}`;
            let tCtx = d.getContext('2d'); drawBird(tCtx, 22, 22, i, currentColor, 0, 0.8);
            d.onclick = () => { currentBird = i; renderChars(); };
            bl.appendChild(d);
        }
        const cl = document.getElementById('colors-list'); cl.innerHTML = '';
        birdColors.forEach(c => {
            let d = document.createElement('div'); d.className = `color-dot ${c===currentColor?'selected':''}`;
            d.style.background = c; d.onclick = () => { currentColor = c; renderChars(); };
            cl.appendChild(d);
        });
    }

    function prepareToPlay() {
        playTransition(() => {
            document.querySelectorAll('.ui-overlay').forEach(el => el.classList.add('hidden'));
            bird = { x: 50, y: 150, gravity: 0.35, lift: -6.5, velocity: 0 };
            pipes = []; frame = 0; score = 0; gameOver = false; gameRunning = true; waitingToStart = true;
        });
    }

    function cycleAudio() { isAudioOn = !isAudioOn; document.getElementById('set-audio').innerText = `AUDIO: ${isAudioOn?'ON':'OFF'}`; }
    function cycleLang() { currentLang = (currentLang==='EN'?'AR':'EN'); document.getElementById('set-lang').innerText = `LANG: ${currentLang}`; }
    function saveSettings() { document.getElementById('ui-title').innerText = langs[currentLang].title; document.getElementById('ui-play').innerText = langs[currentLang].play; document.getElementById('ui-birds').innerText = langs[currentLang].birds; updateHighScoreUI(); toggleSettings(); }
    function toggleSettings() { document.getElementById('settingsMenu').classList.toggle('hidden'); }
    function showChars() { currentBird = savedBird; currentColor = savedColor; document.getElementById('mainLobby').classList.add('hidden'); document.getElementById('charMenu').classList.remove('hidden'); renderChars(); }
    function saveSelection() { savedBird = currentBird; savedColor = currentColor; backToLobby(); }
    function cancelSelection() { backToLobby(); }
    function backToLobby() { document.querySelectorAll('.ui-overlay').forEach(el => el.classList.add('hidden')); document.getElementById('mainLobby').classList.remove('hidden'); }
    function playTransition(cb) { document.getElementById('shutter-l').classList.add('active'); document.getElementById('shutter-r').classList.add('active'); setTimeout(() => { cb(); setTimeout(() => { document.getElementById('shutter-l').classList.remove('active'); document.getElementById('shutter-r').classList.remove('active'); }, 200); }, 500); }
    function update() { if (!gameRunning || gameOver || waitingToStart) return; bird.velocity += bird.gravity; bird.y += bird.velocity; if (frame++ % 90 === 0) { let h = Math.floor(Math.random() * 200) + 50; pipes.push({ x: 320, top: h, bottom: 480 - h - 150 }); } pipes.forEach((p, i) => { p.x -= 2.5; if (bird.x + 12 > p.x && bird.x - 12 < p.x + 50) { if (bird.y - 10 < p.top || bird.y + 10 > 480 - p.bottom) endGame(); } if (p.x + 50 === 50) { score++; playSound(800, 'sine', 0.1); } if (p.x + 50 < 0) pipes.splice(i, 1); }); if (bird.y > 480 || bird.y < 0) endGame(); }
    function endGame() { gameOver = true; playSound(150, 'sawtooth', 0.5); if (score > highScore) { highScore = score; localStorage.setItem('flappyWorldBest', highScore); updateHighScoreUI(); } document.getElementById('gameOverMenu').classList.remove('hidden'); document.getElementById('txt-score').innerText = "SCORE: " + score; }
    function draw() { drawBackground(); if(gameRunning) { pipes.forEach(p => { ctx.fillStyle = "#73BF2E"; ctx.fillRect(p.x, 0, 50, p.top); ctx.fillRect(p.x, 480 - p.bottom, 50, p.bottom); ctx.strokeStyle="#000"; ctx.lineWidth=3; ctx.strokeRect(p.x, 0, 50, p.top); ctx.strokeRect(p.x, 480-p.bottom, 50, p.bottom); }); drawBird(ctx, bird.x, bird.y, savedBird, savedColor, frame*0.2); if(waitingToStart) { ctx.fillStyle="white"; ctx.font="10px 'Press Start 2P'"; ctx.textAlign="center"; ctx.fillText("TAP TO START", 160, 240); } ctx.fillStyle="white"; ctx.strokeStyle="black"; ctx.lineWidth=4; ctx.font="25px 'Press Start 2P'"; ctx.textAlign="center"; ctx.strokeText(score, 160, 60); ctx.fillText(score, 160, 60); } pCtx.clearRect(0,0,50,50); drawBird(pCtx, 25, 25, currentBird, currentColor, Date.now()/100); requestAnimationFrame(draw); }
    const action = () => { if(waitingToStart) waitingToStart = false; if(gameRunning && !gameOver) { bird.velocity = bird.lift; playSound(400, 'square', 0.05); } };
    window.addEventListener("keydown", (e) => { if(e.code === "Space") action(); });
    canvas.addEventListener("mousedown", action);
    updateHighScoreUI(); draw(); setInterval(update, 1000/60);
    function transitionToLobby() { playTransition(() => { gameRunning = false; backToLobby(); }); }
</script>
</body>
</html>